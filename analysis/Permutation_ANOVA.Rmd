---
title: "proj3"
author: "Feifan&Judy"
date: "2024-10-21"
output: html_document
---
```{r}  
#load("/Users/xxxxoxygene/Downloads/treatment.rda")
banana = read.csv("../data/banana_data.csv")
```

```{r}
banana$average_taste <- apply(banana[, c('taste_1', 'taste_2', 'taste_3')], 1, mean)
```

## Permutation test: Holes

```{r}
permutation_test_hole <- function(data, feature, n_permutations = 1000) {
  observed_difference <- with(data, mean(get(feature)[hole_treatment == "H"]) - 
                                     mean(get(feature)[hole_treatment == "NH"]))
  
  permuted_diff <- numeric(n_permutations)
  
  for (perm in seq_len(n_permutations)) {
    shuffled_treatment <- sample(data$hole_treatment)
    permuted_diff[perm] <- with(data, mean(get(feature)[shuffled_treatment == "H"]) - 
                                       mean(get(feature)[shuffled_treatment == "NH"]))
  }
  
  p_value <- mean(permuted_diff >= observed_difference)
  
  return(list(observed = observed_difference, p_val = p_value))
}
permutation_test_hole(banana, "color")$p_val
permutation_test_hole(banana, "average_taste")$p_val

```

```{r invert_test}

```

## Permutation test: Liquid

```{r}
perm_test_diet_coke <- function(data, feature, n_perm = 1000) {
  subset_data <- subset(data, liquid_treatment %in% c("DC", "NL"))
  
  observed_stat <- mean(subset_data[[feature]][subset_data$liquid_treatment == "DC"]) -
                   mean(subset_data[[feature]][subset_data$liquid_treatment == "NL"])
  
  perm_diff <- replicate(n_perm, {
    shuffled_liquid <- sample(subset_data$liquid_treatment)
    mean(subset_data[[feature]][shuffled_liquid == "DC"]) - 
    mean(subset_data[[feature]][shuffled_liquid == "NL"])
  })
  
  p_val <- mean(perm_diff >= observed_stat)
  
  return(list(observed_stat = observed_stat, p_value = p_val))
}

perm_test_diet_coke(banana, "color")$p_value
perm_test_diet_coke(banana, "average_taste")$p_value

```

```{r invert_test}

```

```{r}
perm_test_milk <- function(df, feature, n_perm = 1000) {
  df_subset <- df[df$liquid_treatment %in% c("M", "NL"), ]
  
  obs_stat <- mean(df_subset[[feature]][df_subset$liquid_treatment == "M"]) - 
              mean(df_subset[[feature]][df_subset$liquid_treatment == "NL"])
  
  perm_results <- numeric(n_perm)
  for (i in 1:n_perm) {
    perm_liquid <- sample(df_subset$liquid_treatment)
    perm_results[i] <- mean(df_subset[[feature]][perm_liquid == "M"]) - 
                       mean(df_subset[[feature]][perm_liquid == "NL"])
  }
  
  p_val <- mean(perm_results >= obs_stat)
  
  return(list(obs_stat = obs_stat, p_value = p_val))
}

perm_test_milk(banana, "color")$p_value
perm_test_milk(banana, "average_taste")$p_value

```

```{r invert_test}

```

## ANOVA permutation for liquid

```{r}
perm_anova_color_test <- function(df, n_perm = 1000) {
  obs_stat <- summary(aov(color ~ liquid_treatment, data = df))[[1]]["F value"][1, ]
  
  perm_f_stats <- replicate(n_perm, {
    df$liquid_treatment <- sample(df$liquid_treatment)
    summary(aov(color ~ liquid_treatment, data = df))[[1]]["F value"][1, ]
  })
  
  p_val <- mean(perm_f_stats >= obs_stat)
  
  return(list(observed = obs_stat, p_value = p_val))
}

perm_anova_color_test(banana)$p_value
```

```{r}
perm_anova_taste_test <- function(df, n_perm = 1000) {
  obs_stat <- summary(aov(average_taste ~ liquid_treatment, data = df))[[1]]["F value"][1, ]
  
  perm_f_stats <- replicate(n_perm, {
    df$liquid_treatment <- sample(df$liquid_treatment)
    summary(aov(average_taste ~ liquid_treatment, data = df))[[1]]["F value"][1, ]
  })
  
  p_val <- mean(perm_f_stats >= obs_stat)
  
  return(list(observed = obs_stat, p_value = p_val))
}

perm_anova_taste_test(banana)$p_value
```
```{r}
perm_anova_interaction_color <- function(df, n_perm = 1000) {
  observed_stat <- summary(aov(color ~ hole_treatment * liquid_treatment, data = df))[[1]]["F value"][1, ]
  
  perm_f_stats <- replicate(n_perm, {
    shuffled_hole <- sample(df$hole_treatment)
    shuffled_liquid <- sample(df$liquid_treatment)
    
    temp_df <- df
    temp_df$hole_treatment <- shuffled_hole
    temp_df$liquid_treatment <- shuffled_liquid
    
    summary(aov(color ~ hole_treatment * liquid_treatment, data = temp_df))[[1]]["F value"][1, ]
  })
  
  p_val <- mean(perm_f_stats >= observed_stat)
  
  return(list(observed = observed_stat, p_value = p_val))
}

perm_anova_interaction_color(banana)$p_value


perm_anova_interaction_taste <- function(df, n_perm = 1000) {
  observed_stat <- summary(aov(average_taste ~ hole_treatment * liquid_treatment, data = df))[[1]]["F value"][1, ]
  
  perm_f_stats <- replicate(n_perm, {
    shuffled_hole <- sample(df$hole_treatment)
    shuffled_liquid <- sample(df$liquid_treatment)
    
    temp_df <- df
    temp_df$hole_treatment <- shuffled_hole
    temp_df$liquid_treatment <- shuffled_liquid
    
    summary(aov(average_taste ~ hole_treatment * liquid_treatment, data = temp_df))[[1]]["F value"][1, ]
  })
  
  p_val <- mean(perm_f_stats >= observed_stat)
  
  return(list(observed = observed_stat, p_value = p_val))
}

perm_anova_interaction_taste(banana)$p_value
```
